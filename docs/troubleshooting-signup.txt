# üîß Troubleshooting: Erro 500 no Signup

## üìã Hist√≥rico do Problema

**Data:** 29 de Setembro de 2025
**Sintoma:** Erro 500 ao tentar criar conta via `supabase.auth.signUp()`
**Status:** ‚úÖ RESOLVIDO

---

## üîç Investiga√ß√£o Realizada

### 1. Verifica√ß√µes no Banco de Dados

#### Tabelas de Usu√°rios
```sql
-- Sistema usa 3 tabelas relacionadas:
- auth.users        (Supabase Auth - autom√°tico)
- public.usuarios   (dados principais - ID, email, nome)
- public.profiles   (perfil completo - full_name, emoji, etc)
Trigger Autom√°tico
O sistema possui um trigger que popula automaticamente usuarios e profiles quando um usu√°rio √© criado em auth.users:
sql-- Fun√ß√£o
CREATE FUNCTION public.handle_new_user()
-- Trigger
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION handle_new_user();
Status do Trigger: ‚úÖ Funcionando corretamente (testado manualmente)
Foreign Keys
sql-- profiles tem FK para auth.users
profiles.id ‚Üí auth.users.id (ON DELETE CASCADE)
2. Pol√≠ticas RLS
Todas as tabelas t√™m RLS ativo:

usuarios: pol√≠ticas permitem INSERT com WITH CHECK (true)
profiles: pol√≠ticas permitem INSERT com WITH CHECK (true)

Status das Pol√≠ticas: ‚úÖ Configuradas corretamente

üéØ Causa Raiz Identificada
O erro 500 tinha duas causas combinadas:
Causa 1: Falta de emailRedirectTo no c√≥digo
O Supabase exige emailRedirectTo quando "Confirm email" est√° ativo.
C√≥digo original (errado):
typescriptawait supabase.auth.signUp({ email, password: senha })
C√≥digo corrigido:
typescriptawait supabase.auth.signUp({ 
  email, 
  password: senha,
  options: {
    emailRedirectTo: `${window.location.origin}/auth`
  }
})
Causa 2: Resend em modo Sandbox
O SMTP customizado (Resend) estava em modo gratuito/sandbox, que s√≥ permite enviar emails para o email verificado do propriet√°rio.
Erro do Resend:
450 You can only send testing emails to your own email address (adilson.matioli@gmail.com)

‚úÖ Solu√ß√£o Aplicada
Corre√ß√£o no C√≥digo
Arquivo: src/app/auth/page.tsx
Linha: ~170
Mudan√ßa: Adicionado emailRedirectTo no signUp()
Configura√ß√£o de Email
Decis√£o: Desabilitar SMTP customizado e usar email service padr√£o do Supabase
Motivo:

Resend gratuito tem limita√ß√µes de sandbox
Dom√≠nio .vercel.app n√£o pode ser verificado no Resend
Email service do Supabase √© gratuito e sem limita√ß√µes

Como configurar:

Dashboard Supabase > Project Settings > Auth
SMTP Settings > Disable Custom SMTP
Emails vir√£o de: noreply@mail.app.supabase.co


üß™ Testes de Verifica√ß√£o
Teste 1: Trigger funciona?
sql-- Inserir usu√°rio em auth.users
INSERT INTO auth.users (id, instance_id, email, encrypted_password, email_confirmed_at, aud, role)
VALUES (gen_random_uuid(), '00000000-0000-0000-0000-000000000000', 'teste@exemplo.com', 
        crypt('senha123', gen_salt('bf')), NOW(), 'authenticated', 'authenticated');

-- Verificar se criou em todas as tabelas
SELECT 
  au.email,
  u.nome as usuarios_nome,
  p.full_name as profiles_nome
FROM auth.users au
LEFT JOIN usuarios u ON au.id = u.id
LEFT JOIN profiles p ON au.id = p.id
WHERE au.email = 'teste@exemplo.com';
Resultado esperado: Todos os campos preenchidos
Teste 2: Signup funciona na interface?

Acesse /auth
Clique em "Criar Conta"
Digite email e senha
Verifique se:

N√£o d√° erro 500
Mensagem de sucesso aparece
Email de confirma√ß√£o chega




üìä Configura√ß√£o Atual
Email Provider

Modo: Supabase Email Service (padr√£o)
SMTP Customizado: Desabilitado
Sender: noreply@mail.app.supabase.co
Confirma√ß√£o de email: Habilitada

Templates de Email

Confirma√ß√£o: Customizado (HTML com branding)
Reset de Senha: Customizado (HTML com branding)
Localiza√ß√£o: Dashboard Supabase > Authentication > Email Templates


üîÆ Melhorias Futuras
Op√ß√£o 1: Comprar Dom√≠nio Pr√≥prio

Comprar dom√≠nio .com (~$10/ano)
Verificar no Resend gratuitamente
Emails viriam de noreply@seudominio.com
Pr√≥s: Mais profissional, menos spam
Contras: Custo adicional, configura√ß√£o DNS

Op√ß√£o 2: Manter Supabase Email Service

Continuar usando servi√ßo padr√£o
Pr√≥s: Gratuito, zero manuten√ß√£o
Contras: Email gen√©rico, pode cair em spam


üìù Li√ß√µes Aprendidas

Sempre configurar emailRedirectTo em ambientes com confirma√ß√£o de email obrigat√≥ria
Testar SMTP em modo sandbox s√≥ funciona com emails autorizados
Triggers funcionam perfeitamente para sincronizar tabelas automaticamente
RLS n√£o bloqueia triggers quando configurado com SECURITY DEFINER
Logs do Supabase s√£o essenciais para debug (Auth Logs mostram erros reais)


üÜò Suporte
Se o problema retornar, verificar nesta ordem:

Email chegando?

Verificar Auth Logs no Supabase
Verificar configura√ß√£o SMTP/Email Service


Usu√°rio sendo criado?

sql   SELECT * FROM auth.users ORDER BY created_at DESC LIMIT 5;

Trigger populando tabelas?

sql   SELECT 
     au.email,
     u.nome,
     p.full_name
   FROM auth.users au
   LEFT JOIN usuarios u ON au.id = u.id
   LEFT JOIN profiles p ON au.id = p.id
   ORDER BY au.created_at DESC
   LIMIT 5;

C√≥digo tem emailRedirectTo?

Verificar src/app/auth/page.tsx linha ~170




Documentado por: Claude AI
Data: 29/09/2025
Vers√£o: v3.3.1

---
