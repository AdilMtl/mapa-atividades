# üìä Views Analytics - Supabase Dashboard

## üìã Vis√£o Geral

Sistema de **7 views anal√≠ticas** criadas no Supabase para dashboard autom√°tico do projeto ROI do Foco. Este documento serve como guia para cria√ß√£o, uso e expans√£o do sistema de analytics.

### **üéØ Objetivo**
Transformar os dados brutos das tabelas (`roi_prediag_sessions`, `roi_leads`, `roi_events`) em insights visuais e m√©tricas estrat√©gicas para tomada de decis√£o.

### **üìä Estrutura de Dados Base**
```sql
-- Tabelas utilizadas:
‚îú‚îÄ‚îÄ roi_prediag_sessions  # Sess√µes completas do diagn√≥stico
‚îú‚îÄ‚îÄ roi_leads            # Emails capturados + segmenta√ß√£o
‚îî‚îÄ‚îÄ roi_events           # Eventos de tracking (ts, event_name, payload)
```

---

## üîí Seguran√ßa das Views

### **‚úÖ Configura√ß√£o Atual (v3.4.2 - Outubro 2025)**

Todas as views est√£o configuradas com `security_invoker = true`, o que significa que executam com as **permiss√µes do usu√°rio que consulta**, n√£o do criador da view.
```sql
-- Exemplo de cria√ß√£o correta de view
CREATE VIEW public.vw_conversao_diaria 
WITH (security_invoker = true) AS  -- ‚Üê Flag cr√≠tica!
SELECT ...
Status de Seguran√ßa:

‚úÖ vw_conversao_diaria - SEGURO (security_invoker = true)
‚úÖ vw_perfil_performance - SEGURO (security_invoker = true)
‚úÖ vw_pain_analysis - SEGURO (security_invoker = true)
‚úÖ vw_events_funnel - SEGURO (security_invoker = true)
‚úÖ vw_activity_heatmap - SEGURO (security_invoker = true)
‚úÖ vw_kpis_executivos - SEGURO (security_invoker = true)
‚úÖ vw_mix_atividades - SEGURO (security_invoker = true)


üìö Hist√≥rico de Corre√ß√µes de Seguran√ßa
v3.4.2 (13/10/2025) - Corre√ß√£o Definitiva
Problema: Views persistindo com SECURITY DEFINER mesmo ap√≥s m√∫ltiplas corre√ß√µes
Causa Raiz: Views criadas com owner 'postgres' (superuser) executam automaticamente como SECURITY DEFINER no PostgreSQL, independente de como s√£o declaradas.
Solu√ß√£o Final:
sql-- Recriar views com flag expl√≠cita
DROP VIEW IF EXISTS public.vw_conversao_diaria CASCADE;
CREATE VIEW public.vw_conversao_diaria 
WITH (security_invoker = true) AS  -- ‚Üê For√ßa execu√ß√£o como usu√°rio consultando
SELECT ...
v3.4.1 (02/10/2025) - Tentativa com CREATE OR REPLACE

‚ùå Falhou: CREATE OR REPLACE VIEW manteve atributo SECURITY DEFINER da view original
Li√ß√£o: REPLACE preserva atributos de seguran√ßa existentes

Setembro 2025 - Primeira Corre√ß√£o

‚ùå Falhou: Tentativa de ALTER VIEW ... OWNER TO authenticator bloqueada por permiss√µes
‚ùå Falhou: DROP + CREATE simples sem security_invoker

Agosto 2025 - Cria√ß√£o Original

Views criadas sem especificar security, herdaram SECURITY DEFINER do owner postgres
Security Advisor detectou vulnerabilidade


üõ°Ô∏è Best Practices para Views
1. Sempre usar security_invoker = true
sql-- ‚úÖ CORRETO - Para views de analytics/dashboards
CREATE VIEW public.vw_sua_view 
WITH (security_invoker = true) AS
SELECT ...

-- ‚ùå EVITAR - Executa como criador da view
CREATE VIEW public.vw_sua_view AS
SELECT ...
2. Verificar configura√ß√£o ap√≥s criar
sql-- Query para verificar security_invoker
SELECT 
    c.relname AS view_name,
    CASE 
        WHEN 'security_invoker=true' = ANY(c.reloptions) 
        THEN '‚úÖ SECURITY INVOKER'
        ELSE '‚ö†Ô∏è SECURITY DEFINER ou n√£o configurado'
    END as security_status
FROM pg_class c
JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE c.relkind = 'v'
AND n.nspname = 'public'
AND c.relname = 'vw_sua_view';
3. Conceder permiss√µes adequadas
sql-- Ap√≥s criar a view, conceder acesso
GRANT SELECT ON public.vw_sua_view TO anon, authenticated;
-- Ou apenas para service_role (admin only)
GRANT SELECT ON public.vw_sua_view TO service_role;

üîç Quando Usar SECURITY DEFINER vs SECURITY INVOKER
Cen√°rioUsarMotivoAnalytics/Dashboards p√∫blicossecurity_invoker = trueUsu√°rios devem ver apenas seus dados via RLSViews administrativassecurity_invoker = true + permiss√£o apenas para service_roleAdmin acessa via API protegidaAgrega√ß√µes complexassecurity_invoker = trueMant√©m RLS das tabelas baseViews com l√≥gica sens√≠velRaramente SECURITY DEFINERApenas se absolutamente necess√°rio
Regra geral: Para este projeto, SEMPRE use security_invoker = true.

‚ö†Ô∏è Troubleshooting
Problema: Security Advisor ainda mostra warnings
sql-- 1. Verificar owner da view
SELECT viewname, viewowner 
FROM pg_views 
WHERE schemaname = 'public' 
AND viewname = 'vw_sua_view';

-- Se owner = 'postgres', a view ter√° SECURITY DEFINER impl√≠cito
-- Solu√ß√£o: Recriar com security_invoker = true

-- 2. Verificar flag security_invoker
SELECT c.relname, c.reloptions
FROM pg_class c
WHERE c.relname = 'vw_sua_view';

-- Se reloptions n√£o cont√©m 'security_invoker=true', recriar
Problema: CREATE OR REPLACE n√£o remove SECURITY DEFINER
Solu√ß√£o: Usar DROP + CREATE ao inv√©s de REPLACE:
sqlDROP VIEW IF EXISTS public.vw_sua_view CASCADE;
CREATE VIEW public.vw_sua_view 
WITH (security_invoker = true) AS
SELECT ...


---

## üîÑ Atualiza√ß√£o: S√©rie Hist√≥rica Completa (Outubro 2025)

### **‚ö° Mudan√ßa Importante**
**ANTES (Agosto 2025):** Views limitadas aos √∫ltimos 30 dias via `WHERE created_at >= NOW() - INTERVAL '30 days'`  
**AGORA (Outubro 2025):** Views mostram **s√©rie hist√≥rica completa** desde o in√≠cio do projeto

### **üìä Impacto**
- ‚úÖ Todas as 7 views agora retornam dados desde **28/08/2025** (primeira sess√£o)
- ‚úÖ Permite an√°lise de tend√™ncias de longo prazo
- ‚úÖ Facilita compara√ß√£o entre per√≠odos diferentes
- ‚úÖ Dashboards Grafana automaticamente exibem s√©rie completa

### **üéØ Views Afetadas**
Todas as 7 views foram atualizadas para remover filtros temporais:
1. `vw_conversao_diaria` - removido filtro de 30 dias
2. `vw_perfil_performance` - removido filtro de 30 dias
3. `vw_pain_analysis` - removido filtro de 30 dias
4. `vw_events_funnel` - removido filtro de 30 dias
5. `vw_activity_heatmap` - removido filtro de 14 dias
6. `vw_kpis_executivos` - removido filtro de 30 dias, per√≠odo alterado para "S√©rie Hist√≥rica Completa"
7. `vw_mix_atividades` - removido filtro de 30 dias

### **üí° Recomenda√ß√£o de Uso**
- **Grafana:** Use o Time Range do dashboard (ex: "Last 90 days") para controlar per√≠odo visualizado
- **SQL Direto:** Adicione `WHERE data >= '2025-09-01'` nas queries quando necess√°rio limitar per√≠odo
- **APIs:** Implemente filtros de data como par√¢metros opcionais

---

## üîß Views Criadas (7 Total)

### **1Ô∏è‚É£ vw_conversao_diaria**
**Prop√≥sito:** Acompanhar evolu√ß√£o di√°ria de convers√µes  
**Uso:** Gr√°ficos de linha temporal, identificar tend√™ncias

```sql
CREATE OR REPLACE VIEW vw_conversao_diaria AS
SELECT 
  DATE(s.created_at) as data,
  COUNT(s.id) as total_sessoes,
  COUNT(l.id) as total_leads,
  ROUND(COUNT(l.id) * 100.0 / NULLIF(COUNT(s.id), 0), 2) as taxa_conversao_pct,
  ROUND(AVG(s.duration_seconds)) as tempo_medio_sessao
FROM roi_prediag_sessions s
LEFT JOIN roi_leads l ON s.id = l.last_session_id
-- NOTA: Filtro temporal removido - mostra s√©rie hist√≥rica completa
GROUP BY DATE(s.created_at)
ORDER BY data DESC;
```

**üìà Casos de Uso:**
- Identificar dias com maior/menor convers√£o
- An√°lise sazonal (fins de semana vs dias √∫teis)
- Correla√ß√£o entre tempo de sess√£o e convers√£o
- A/B testing de campanhas por per√≠odo

---

### **2Ô∏è‚É£ vw_perfil_performance**
**Prop√≥sito:** Segmenta√ß√£o por perfil profissional  
**Uso:** Direcionamento de campanhas, persona analysis

```sql
CREATE OR REPLACE VIEW vw_perfil_performance AS
SELECT 
  COALESCE(profile, 'N√£o informado') as perfil,
  COUNT(*) as total_sessoes,
  COUNT(l.email) as total_leads,
  ROUND(COUNT(l.email) * 100.0 / NULLIF(COUNT(*), 0), 2) as taxa_conversao_pct,
  ROUND(AVG(duration_seconds)) as tempo_medio_sessao,
  ROUND(AVG(mix_distracao)) as media_distracao_pct,
  ROUND(AVG(mix_essencial)) as media_essencial_pct,
  ROUND(AVG(mix_estrategico)) as media_estrategico_pct,
  ROUND(AVG(mix_tatico)) as media_tatico_pct
FROM roi_prediag_sessions s
LEFT JOIN roi_leads l ON s.id = l.last_session_id
-- NOTA: Filtro temporal removido - mostra s√©rie hist√≥rica completa
GROUP BY profile
ORDER BY total_sessoes DESC;
```

**üéØ Insights Estrat√©gicos:**
- Qual perfil converte melhor (foco de ads)
- Perfis com maior n√≠vel de distra√ß√£o (oportunidades)
- Tempo m√©dio por perfil (otimiza√ß√£o UX)
- Mix de atividades por persona

---

### **3Ô∏è‚É£ vw_pain_analysis**
**Prop√≥sito:** An√°lise por dores/pain points dos usu√°rios  
**Uso:** Content marketing, segmenta√ß√£o avan√ßada

```sql
CREATE OR REPLACE VIEW vw_pain_analysis AS
SELECT 
  COALESCE(pain, 'N√£o informado') as principal_dor,
  COUNT(*) as total_sessoes,
  COUNT(l.email) as total_leads,
  ROUND(COUNT(l.email) * 100.0 / NULLIF(COUNT(*), 0), 2) as taxa_conversao_pct,
  ROUND(AVG(mix_distracao)) as nivel_distracao_medio,
  ROUND(AVG(mix_essencial)) as nivel_essencial_medio
FROM roi_prediag_sessions s
LEFT JOIN roi_leads l ON s.id = l.last_session_id
-- NOTA: Filtro temporal removido - mostra s√©rie hist√≥rica completa
GROUP BY pain
ORDER BY taxa_conversao_pct DESC;
```

**üîç Aplica√ß√µes:**
- Dores que mais convertem (criar conte√∫do espec√≠fico)
- Correla√ß√£o entre dor e n√≠vel de distra√ß√£o
- Personaliza√ß√£o de email marketing por pain point
- Desenvolvimento de produtos/servi√ßos direcionados

---

### **4Ô∏è‚É£ vw_events_funnel**
**Prop√≥sito:** Funil de convers√£o por eventos  
**Uso:** Identificar gargalos no processo, otimiza√ß√£o UX

```sql
CREATE OR REPLACE VIEW vw_events_funnel AS
SELECT 
  event_name as evento,
  COUNT(*) as total_eventos,
  COUNT(DISTINCT session_id) as sessoes_unicas,
  ROUND(COUNT(*) * 100.0 / 
    (SELECT COUNT(*) FROM roi_events), 2) as percentual_total
    -- NOTA: Subquery tamb√©m sem filtro temporal
FROM roi_events
-- NOTA: Filtro temporal removido - mostra s√©rie hist√≥rica completa
GROUP BY event_name
ORDER BY total_eventos DESC;
```

**üöÄ Otimiza√ß√µes Baseadas em Dados:**
- Taxa de abandono entre `prediag_completed` e `email_submitted`
- Eventos que mais antecedem convers√£o
- Identifica√ß√£o de friction points
- A/B testing de CTAs e formul√°rios

---

### **5Ô∏è‚É£ vw_activity_heatmap**
**Prop√≥sito:** Heatmap temporal de atividade  
**Uso:** Otimiza√ß√£o de hor√°rios de campaign, an√°lise comportamental

```sql
CREATE OR REPLACE VIEW vw_activity_heatmap AS
SELECT 
  EXTRACT(DOW FROM s.created_at) as dia_semana, -- 0=Domingo, 6=S√°bado
  EXTRACT(HOUR FROM s.created_at) as hora,
  COUNT(*) as total_sessoes,
  COUNT(l.email) as leads_gerados,
  CASE EXTRACT(DOW FROM s.created_at)
    WHEN 0 THEN 'Domingo' WHEN 1 THEN 'Segunda' WHEN 2 THEN 'Ter√ßa'
    WHEN 3 THEN 'Quarta' WHEN 4 THEN 'Quinta' WHEN 5 THEN 'Sexta'
    WHEN 6 THEN 'S√°bado'
  END as nome_dia
FROM roi_prediag_sessions s
LEFT JOIN roi_leads l ON s.id = l.last_session_id
-- NOTA: Filtro temporal removido (era 14 dias) - mostra s√©rie hist√≥rica completa
GROUP BY EXTRACT(DOW FROM s.created_at), EXTRACT(HOUR FROM s.created_at)
ORDER BY dia_semana, hora;
```

**‚è∞ Estrat√©gias Baseadas em Tempo:**
- Melhores hor√°rios para email marketing
- Dias da semana com maior convers√£o
- Planejamento de campanhas pagas
- Otimiza√ß√£o de disponibilidade de suporte

---

### **6Ô∏è‚É£ vw_kpis_executivos**
**Prop√≥sito:** Dashboard executivo com m√©tricas principais  
**Uso:** Relat√≥rios gerenciais, acompanhamento de performance geral

```sql
CREATE OR REPLACE VIEW vw_kpis_executivos AS
SELECT 
  'S√©rie Hist√≥rica Completa' as periodo, -- ATUALIZADO
  COUNT(DISTINCT s.id) as total_sessoes,
  COUNT(DISTINCT l.email) as total_leads_unicos,
  ROUND(COUNT(DISTINCT l.email) * 100.0 / NULLIF(COUNT(DISTINCT s.id), 0), 2) as conversao_geral_pct,
  ROUND(AVG(s.duration_seconds)) as tempo_medio_sessao_seg,
  COUNT(DISTINCT DATE(s.created_at)) as dias_com_atividade,
  ROUND(COUNT(DISTINCT s.id) * 1.0 / NULLIF(COUNT(DISTINCT DATE(s.created_at)), 0), 1) as sessoes_por_dia,
  ROUND(AVG(s.mix_essencial)) as mix_essencial_medio,
  ROUND(AVG(s.mix_distracao)) as mix_distracao_medio,
  (SELECT COALESCE(profile, 'N√£o informado') FROM roi_prediag_sessions 
   -- NOTA: Subquery sem filtro temporal
   GROUP BY profile ORDER BY COUNT(*) DESC LIMIT 1) as perfil_dominante,
  (SELECT COALESCE(pain, 'N√£o informado') FROM roi_prediag_sessions 
   -- NOTA: Subquery sem filtro temporal
   GROUP BY pain ORDER BY COUNT(*) DESC LIMIT 1) as dor_dominante
FROM roi_prediag_sessions s
LEFT JOIN roi_leads l ON s.id = l.last_session_id;
-- NOTA: Filtro temporal removido - mostra s√©rie hist√≥rica completa
```

**üìã KPIs Monitorados:**
- Taxa de convers√£o geral
- Volume de sess√µes e leads
- Tempo m√©dio de sess√£o
- Mix de atividades m√©dio
- Perfil e dor dominantes
- Frequ√™ncia de atividade

---

### **7Ô∏è‚É£ vw_mix_atividades**
**Prop√≥sito:** An√°lise detalhada do mix de atividades por perfil  
**Uso:** Insights sobre produtividade, valida√ß√£o da metodologia ROI

```sql
CREATE OR REPLACE VIEW vw_mix_atividades AS
SELECT 
  COALESCE(profile, 'N√£o informado') as perfil,
  COUNT(*) as total_sessoes,
  ROUND(AVG(mix_essencial)) as avg_essencial,
  ROUND(AVG(mix_estrategico)) as avg_estrategico,
  ROUND(AVG(mix_tatico)) as avg_tatico,
  ROUND(AVG(mix_distracao)) as avg_distracao,
  CASE 
    WHEN AVG(mix_essencial) >= AVG(mix_estrategico) 
         AND AVG(mix_essencial) >= AVG(mix_tatico) 
         AND AVG(mix_essencial) >= AVG(mix_distracao) THEN 'Focado Essencial'
    WHEN AVG(mix_estrategico) >= AVG(mix_tatico) 
         AND AVG(mix_estrategico) >= AVG(mix_distracao) THEN 'Focado Estrat√©gico'
    WHEN AVG(mix_tatico) >= AVG(mix_distracao) THEN 'Focado T√°tico'
    ELSE 'Alto N√≠vel Distra√ß√£o'
  END as classificacao_foco
FROM roi_prediag_sessions
-- NOTA: Filtro temporal removido - mostra s√©rie hist√≥rica completa
GROUP BY profile
ORDER BY avg_essencial DESC;
```

**üéØ Valida√ß√µes de Neg√≥cio:**
- Efic√°cia da metodologia ROI do Foco
- Perfis com maior necessidade do produto
- Oportunidades de coaching/consultoria
- Desenvolvimento de features espec√≠ficas

---

## üìä Como Usar as Views

### **1. Consultas Diretas (SQL Editor)**
```sql
-- Dashboard principal
SELECT * FROM vw_kpis_executivos;

-- Performance por perfil
SELECT * FROM vw_perfil_performance ORDER BY taxa_conversao_pct DESC;

-- Funil de convers√£o
SELECT * FROM vw_events_funnel;

-- Convers√£o di√°ria com filtro manual (opcional)
SELECT * FROM vw_conversao_diaria 
WHERE data >= '2025-09-01'  -- Adicione filtro quando necess√°rio
ORDER BY data DESC;
```

### **2. APIs Next.js**
```typescript
// app/api/dashboard/kpis/route.ts
import { createClient } from '@supabase/supabase-js';

export async function GET() {
  const supabase = createClient(process.env.SUPABASE_URL!, process.env.SUPABASE_ANON_KEY!);
  
  const { data, error } = await supabase
    .from('vw_kpis_executivos')
    .select('*');
    
  return Response.json({ data, error });
}

// Com filtro de data opcional
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const startDate = searchParams.get('start_date');
  
  const supabase = createClient(process.env.SUPABASE_URL!, process.env.SUPABASE_ANON_KEY!);
  
  let query = supabase.from('vw_conversao_diaria').select('*');
  
  if (startDate) {
    query = query.gte('data', startDate);
  }
  
  const { data, error } = await query;
  return Response.json({ data, error });
}
```

### **3. Dashboards Externos**

#### **Grafana (Recomendado)**
- Connection: PostgreSQL direto no Supabase
- Queries: Use as views como source
- **Time Range:** Configure "Last 90 days" como padr√£o, ajuste conforme necess√°rio
- Templates: Dashboards pr√©-configurados

#### **Metabase/Superset**
- Setup: Docker ou cloud
- Connection: Supabase PostgreSQL URL
- Automation: Refresh autom√°tico
- **Filtros:** Configure filtros de data na interface visual

#### **Power BI/Tableau**
- Connector: PostgreSQL
- Refresh: Scheduled updates
- Sharing: Enterprise dashboards
- **Per√≠odo:** Use filtros nativos de date range

---

## üîß Manuten√ß√£o e Evolu√ß√£o

### **Adicionando Novas Views**

#### **Template Base**
```sql
-- Padr√£o para novas views (SEM filtro temporal hardcoded)
CREATE OR REPLACE VIEW vw_nova_metrica AS
SELECT 
  -- Dimens√µes (group by)
  coluna_agrupamento,
  
  -- M√©tricas b√°sicas
  COUNT(*) as total_registros,
  
  -- M√©tricas calculadas
  ROUND(AVG(coluna_numerica)) as media_calculada,
  
  -- Classifica√ß√µes
  CASE 
    WHEN condicao THEN 'Categoria A'
    ELSE 'Categoria B'
  END as classificacao
  
FROM tabela_principal p
LEFT JOIN tabela_relacionada r ON p.id = r.foreign_key
-- IMPORTANTE: N√ÉO adicionar filtros temporais hardcoded
-- Deixe o controle de per√≠odo para o dashboard/query
WHERE p.coluna_filtro IS NOT NULL
GROUP BY coluna_agrupamento
ORDER BY total_registros DESC;
```

#### **Conven√ß√µes de Nomenclatura**
- **Prefixo**: `vw_` (view)
- **Categoria**: `conversao_`, `perfil_`, `temporal_`, `mix_`
- **Sufixo**: `_diario`, `_mensal`, `_performance`, `_analysis`

#### **Exemplos de Expans√£o**
```sql
-- View para an√°lise mensal
CREATE OR REPLACE VIEW vw_conversao_mensal AS
SELECT 
  DATE_TRUNC('month', data) as mes,
  SUM(total_sessoes) as sessoes_mes,
  SUM(total_leads) as leads_mes,
  ROUND(SUM(total_leads) * 100.0 / NULLIF(SUM(total_sessoes), 0), 2) as taxa_conversao_mes
FROM vw_conversao_diaria
GROUP BY DATE_TRUNC('month', data)
ORDER BY mes DESC;

-- View para an√°lise de reten√ß√£o
CREATE OR REPLACE VIEW vw_retencao_cohort AS ...

-- View para ROI por canal
CREATE OR REPLACE VIEW vw_roi_por_canal AS ...
```

### **Otimiza√ß√£o de Performance**

#### **√çndices Necess√°rios**
```sql
-- Para queries temporais
CREATE INDEX CONCURRENTLY idx_sessions_created_date 
ON roi_prediag_sessions (DATE(created_at));

-- Para segmenta√ß√£o
CREATE INDEX CONCURRENTLY idx_sessions_profile_pain
ON roi_prediag_sessions (profile, pain);
-- NOTA: Removido filtro WHERE do √≠ndice parcial

-- Para eventos
CREATE INDEX CONCURRENTLY idx_events_name_ts
ON roi_events (event_name, ts);
```

#### **Materializa√ß√£o (Para Alto Volume)**
```sql
-- Converter view em tabela materializada
CREATE MATERIALIZED VIEW mv_kpis_executivos AS
SELECT * FROM vw_kpis_executivos;

-- Refresh programado
REFRESH MATERIALIZED VIEW mv_kpis_executivos;
```

### **Monitoramento de Views**
```sql
-- Query para verificar performance das views
SELECT 
  schemaname,
  viewname,
  definition
FROM pg_views 
WHERE viewname LIKE 'vw_%'
ORDER BY viewname;

-- Verificar uso das views (via pg_stat_statements)
SELECT 
  query,
  calls,
  total_time,
  mean_time
FROM pg_stat_statements 
WHERE query ILIKE '%vw_%'
ORDER BY mean_time DESC;
```

---

## üìà M√©tricas de Sucesso

### **KPIs Principais Monitorados**
- **Taxa de Convers√£o Geral**: Meta > 15%
- **Tempo M√©dio de Sess√£o**: Meta < 5 minutos
- **Mix Essencial M√©dio**: Meta > 40%
- **Mix Distra√ß√£o M√©dio**: Meta < 15%
- **Sess√µes por Dia**: Meta > 10/dia

### **Alertas Configur√°veis**
```sql
-- Alert: Convers√£o muito baixa
SELECT 'ALERT: Convers√£o baixa' as status
FROM vw_kpis_executivos 
WHERE conversao_geral_pct < 10;

-- Alert: Alto n√≠vel de distra√ß√£o
SELECT 'ALERT: Distra√ß√£o alta' as status
FROM vw_kpis_executivos 
WHERE mix_distracao_medio > 20;
```

---

## üîÆ Roadmap Analytics

### **Fase 2: Analytics Avan√ßados**
- [ ] **Cohort Analysis**: Reten√ß√£o por per√≠odo de cadastro
- [ ] **Funnel Analysis**: An√°lise detalhada de abandono
- [ ] **Attribution Modeling**: ROI por canal de aquisi√ß√£o
- [ ] **Predictive Analytics**: ML para scoring de leads

### **Fase 3: Real-time Analytics**
- [ ] **Stream Processing**: M√©tricas em tempo real
- [ ] **Event-driven Architecture**: Triggers autom√°ticos
- [ ] **Alert System**: Notifica√ß√µes autom√°ticas
- [ ] **A/B Testing Framework**: Testes automatizados

### **Fase 4: Business Intelligence**
- [ ] **Executive Reporting**: Relat√≥rios autom√°ticos
- [ ] **Competitive Analysis**: Benchmarking de mercado
- [ ] **Revenue Analytics**: LTV, CAC, ROI financeiro
- [ ] **Product Analytics**: Feature usage, engagement

---

## üìö Recursos e Refer√™ncias

### **Documenta√ß√£o T√©cnica**
- [Supabase Views Documentation](https://supabase.com/docs/guides/database/views)
- [PostgreSQL Views Best Practices](https://www.postgresql.org/docs/current/sql-createview.html)
- [SQL Analytics Patterns](https://mode.com/sql-tutorial/)

### **Ferramentas de Visualiza√ß√£o**
- [Grafana + PostgreSQL](https://grafana.com/docs/grafana/latest/datasources/postgres/)
- [Metabase Open Source](https://www.metabase.com/)
- [Apache Superset](https://superset.apache.org/)

### **Arquivos Relacionados**
```
docs/
‚îú‚îÄ‚îÄ tabelas-supabase.md         # Schema das tabelas base
‚îú‚îÄ‚îÄ api-prediagnostico.md       # APIs que alimentam os dados
‚îú‚îÄ‚îÄ views-analytics-supabase.md # Este documento
‚îî‚îÄ‚îÄ dashboard-grafana-supabase.md # Setup do Grafana
```

---

## ‚úÖ Checklist de Implementa√ß√£o

### **Setup Inicial**
- [x] Tabelas base criadas (roi_prediag_sessions, roi_leads, roi_events)
- [x] Views anal√≠ticas implementadas (7 views)
- [x] **Corre√ß√£o de seguran√ßa aplicada** (views sem SECURITY DEFINER)
- [x] **Filtros temporais removidos** (s√©rie hist√≥rica completa)
- [x] Permiss√µes adequadas configuradas (anon + authenticated)
- [x] Testes de performance executados
- [x] Valida√ß√£o de seguran√ßa aprovada (Security Advisor)

### **Pr√≥ximos Passos**
- [x] Dashboard visual configurado (Grafana)
- [ ] APIs de consulta implementadas com filtros opcionais
- [ ] Monitoramento de performance ativo
- [ ] Sistema de alertas configurado
- [ ] Backups autom√°ticos das views
- [ ] Treinamento da equipe no uso das views
- [ ] **Monitoramento cont√≠nuo de seguran√ßa** (Security Advisor mensalmente)

---

**üìä Sistema Analytics ROI do Foco - Views Supabase**  
**üîÑ √öltima atualiza√ß√£o:** Outubro 2025 (S√©rie Hist√≥rica Completa)  
**üë• Respons√°vel:** Equipe de Desenvolvimento  
**üîí Status Seguran√ßa:** ‚úÖ Aprovado (Security Advisor)  
**üìß Contato:** Para d√∫vidas t√©cnicas, consulte a documenta√ß√£o ou abra issue no reposit√≥rio